# sif-ai-form-service

Python microservice for the SIF AI form flow. Runs the DSPy planner and returns form steps as JSON
(or SSE streaming when requested).

## Endpoints

- `GET /health`
- `POST /v1/api/form` (JSON by default, SSE when `Accept: text/event-stream` or `?stream=1`)
- `GET /v1/api/form/capabilities` (JSON; contract schema + version)
- `POST /v1/api/image` (image prompt + image generation)

## API contract workflow (OpenAPI)

This repo commits its OpenAPI spec as a machine-enforced contract for frontend/backed integration.

- Update: `make export-openapi-contract`
- Verify (CI): `make verify-openapi-contract`

## Shared UI contract (vendored)

The canonical "UIStep contract" lives under `shared/ai-form-contract/`:
- `shared/ai-form-contract/schema/schema_version.txt`
- `shared/ai-form-contract/schema/ui_step.schema.json`
- `shared/ai-form-contract/schema/ui_step.types.ts`
- `shared/ai-form-contract/demos/next_steps_examples.jsonl`

This folder is committed so the service can return `schemaVersion` + `uiStepSchema` via `GET /v1/api/form/capabilities`.

## Local dev

**Quick start:** Copy `.env.example` to `.env` and fill in your values. The app auto-loads `.env` and `.env.local` (no `source .env` needed).

**Required env vars:**

**Supabase (for minimal API requests):**
- `SUPABASE_URL` or `NEXT_PUBLIC_SUPABASE_URL` - Your Supabase project URL
- `SUPABASE_SERVICE_ROLE_KEY` - Service role key (for backend access)

**DSPy (for LLM calls):**
- `DSPY_PROVIDER=groq` (or `openai`)
- `GROQ_API_KEY=...` (or `OPENAI_API_KEY=...`)
- `DSPY_MODEL_LOCK=llama-3.3-70b-versatile` (optional)

**Optional:**
- `DSPY_NEXT_STEPS_DEMO_PACK=/absolute/or/repo/relative/path.jsonl` (optional override)
  - Default demo pack is `shared/ai-form-contract/demos/next_steps_examples.jsonl` if present
  - Schema version is read from `shared/ai-form-contract/schema/schema_version.txt`
- Image generation:
  - `IMAGE_PROVIDER=mock` (default; returns SVG data URLs)
  - `DSPY_IMAGE_PROMPT_MAX_TOKENS=900` (prompt-builder token cap)

Install + run:

```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
# Either entrypoint works:
uvicorn api.main:app --reload --port 8008
# uvicorn api.main:app --reload --port 8008 (legacy entry point)
```

Test health:

```bash
curl -s http://localhost:8008/health | jq
```

Test form generation (JSON):

```bash
curl -X POST http://localhost:8008/api/form \
  -H 'content-type: application/json' \
  -d '{"mode":"next_steps","batchId":"ContextCore","platformGoal":"test","businessContext":"test","industry":"General","service":"","requiredUploads":[],"personalizationSummary":"","stepDataSoFar":{},"alreadyAskedKeys":[],"batchState":{},"allowedMiniTypes":["multiple_choice"],"maxSteps":3}'
```

Test streaming (SSE):

```bash
curl -N -X POST 'http://localhost:8008/api/form?stream=1' \
  -H 'accept: text/event-stream' \
  -H 'content-type: application/json' \
  -d '{"mode":"next_steps","batchId":"ContextCore","platformGoal":"test","businessContext":"test","industry":"General","service":"","requiredUploads":[],"personalizationSummary":"","stepDataSoFar":{},"alreadyAskedKeys":[],"batchState":{},"allowedMiniTypes":["multiple_choice"],"maxSteps":3}'
```

Test image generation (JSON):

```bash
curl -X POST http://localhost:8008/api/image \
  -H 'content-type: application/json' \
  -d '{"instanceId":"uuid-here","useCase":"scene","numOutputs":2,"outputFormat":"url","stepDataSoFar":{"step-space-type":"kitchen","step-budget":"5000"},"config":{"platformGoal":"AI pre-design intake","businessContext":"We generate AI images for early design concepts","industry":"Interior Design","service":"Kitchen Remodel","personalizationSummary":"Bright, warm, natural materials"}}'
```

## Deploy to Vercel

This repo is set up as a Vercel **Python Serverless Function** with a catch-all route to `api/index.py`
(see `vercel.json`).

### Deployment Protection (401 Authentication Required)

If `GET /health` returns **401 Authentication Required**, your deployment is behind **Vercel Deployment Protection**
(sometimes shown as “Vercel Authentication”).

You have two options:

- **Make it public (recommended)**: Vercel Dashboard → Project → Settings → Deployment Protection → set **Production** to **Disabled/Public**.
- **Keep protection ON (automation bypass)**: enable **Protection Bypass for Automation** in the same settings page and use the
  generated bypass secret in your server-to-server requests:
  - Send header **`x-vercel-protection-bypass: <BYPASS_SECRET>`**
  - Vercel also exposes this secret to the deployment as **`VERCEL_AUTOMATION_BYPASS_SECRET`**

In Vercel Project Settings, set required env vars (same as local dev):
- `SUPABASE_URL` or `NEXT_PUBLIC_SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY`
- `DSPY_PROVIDER`
- `DSPY_MODEL_LOCK` (optional)
- `GROQ_API_KEY` (or `OPENAI_API_KEY` if using `DSPY_PROVIDER=openai`)

Deploy:
- **Git**: import the repo in Vercel and deploy from the dashboard
- **CLI**: from the repo root, run `vercel` (and `vercel --prod` when ready)

After deploy, verify:

```bash
curl -s https://YOUR_VERCEL_DOMAIN/health | jq
```

## Verify streaming on Vercel

```bash
curl -N -X POST 'https://YOUR_VERCEL_DOMAIN/api/form?stream=1' \
  -H 'accept: text/event-stream' \
  -H 'content-type: application/json' \
  -d '{"mode":"next_steps","batchId":"ContextCore","platformGoal":"test","businessContext":"test","industry":"General","service":"","requiredUploads":[],"personalizationSummary":"","stepDataSoFar":{},"alreadyAskedKeys":[],"formPlan":[],"batchState":{},"allowedMiniTypes":["multiple_choice"],"maxSteps":3}'
```
